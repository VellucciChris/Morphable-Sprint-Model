clear all
close all
clc

load('FAST_PCAINPUT_LP250.mat');

%%Scale to height (based on max point of head marker)
%heights = max(PCAinput.Data(:,12928:end)');

%PCAINPUT.Matrix = PCA_data;
%PCAINPUT.Matrix(85:end,:)=[];

PCA_data=PCAINPUT.Aligned_Kin;

lightBlue = [91, 180, 250] / 255; 
DarkBlue = [0, 0, 100] / 255;
%%
myVideo = VideoWriter('/Users/chris/Library/CloudStorage/OneDrive-BrockUniversity/PhD/MCR_April_!4.avi');
%SCR = 12;
SCR1 = 1;
SCR2 = 3;
SCR3 = 9; 
SCR4 = 11; 
SCR5 = 12; 
SCR6 = 13; 
SCR7 = 16; 
%SCR2= 11;

[coeff,score,latent,tsquared,explained,mu] = pca(PCA_data);

TotalExplained = cumsum(explained);

x=[1;5;;10;15;20;25;30;35;39];

muExp =mean(explained)

% Catrell's Scree Plot Test 
figure(1)
% plot(explained,'Color',DarkBlue,'LineStyle','-','LineWidth',3.5)
% hold on 
%scatter(1:39,explained,100,'filled','s','MarkerFaceColor',lightBlue)
ax = axes; 
yyaxis('left');
bar(1:39,explained,'FaceColor',lightBlue)
hold on
bar(1:21,explained(1:21),'FaceColor',DarkBlue)
xlim([0 40])
ylim([0 27])
ylabel('Explained Variance (%)')
yline(muExp,'--','LineWidth',2,Color=[ 0.9100 0.4100 0.1700])
text(35-0.5,muExp+0.5,'Average','FontSize',15,Color=[ 0.9100 0.4100 0.1700])
yyaxis('right')
plot(1:39,TotalExplained,LineWidth=2,Color=[ 0.9100 0.4100 0.1700])
ylabel('Cum Explained (%)')
xlabel('PC')
ylim([0 102])
set(gca,'FontSize',20)
ax.YAxis(1).Color = 'k';
ax.YAxis(2).Color = 'k';
hold off
legend ('Excluded PCs','Retained PCs','','Cum Explained','Horizontal')
%% Loading Vector Graph To Determine the influence of the PC on the X, Y and Z coordinates 

KIN_PCS = [1,3,9,11,12,13,16];
PC_A = KIN_PCS(1);
KIN_PCS = KIN_PCS(1:end);
LPCS=length(KIN_PCS);
a = 2 % set column on subplot
b = 3 % set row on subplot

for n=1:LPCS-1
    PC_B = KIN_PCS(n+1)

    x1 = coeff(1:6464,PC_A);
    x2 = coeff(1:6464,PC_B);

    y1 = coeff(6465:12928,PC_A);
    y2 = coeff(6465:12928,PC_B);
    z1 = coeff(12929:end,PC_A); 
    z2 = coeff(12929:end,PC_B); 

    x1 = reshape(x1,101,64);
    x2 = reshape(x2,101,64);
    y1 = reshape(y1,101,64);
    y2 = reshape(y2,101,64);
    z1 = reshape(z1,101,64);
    z2 = reshape(z2,101,64);


    ensmb = [x1,y1,z1]; 
    Mtemp_1 = mean(ensmb,2);

    ensmb = [x2,y2,z2]; 
    Mtemp_2 = mean(ensmb,2);

    TEMP = [Mtemp_1,Mtemp_2];

    col= turbo(length(TEMP)); 
    colormap(col)

    figure(1)
    subplot(a,b,n)
    h1 = biplot(TEMP)
    pc_a = string(PC_A);
    pc_b = string(PC_B);
    xlabel(join(['PC',pc_a]))
    ylabel(join(['PC',pc_b]))
    c = colorbar
    set(gca,'FontSize',22)
    c.TickLabels= 0:20:100; 
    c.Label.String = '% Cycle'


    for k = 1:length(TEMP);
        h1(k).Color = col(k,:);
    end


    ensmb = [x1;y1;z1]; 
    Mspatial_1 = mean(ensmb,1); 

    ensmb = [x2;y2;z2]; 
    Mspatial_2 = mean(ensmb,1); 

    SPATIAL = [Mspatial_1; Mspatial_2]';
% 
%     Axial = SPATIAL([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],:);
%     Right_UE = SPATIAL([21,23,24,27,28,29,33,34,35],:);
%     Left_UE = SPATIAL([22,25,26,30,31,32,36,37,38,],:);
%     Right_LE = SPATIAL([39,40,41,42,47,48,49,53,54,55,56,57,58],:);
%     Left_LE = SPATIAL([43,44,45,46,50,51,52,59,60,61,62,63,64],:);

   
%     Axial = mean(SPATIAL([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],:),1);
%     Right_UE = mean(SPATIAL([21,23,24,27,28,29,33,34,35],:),1);
%     Left_UE = mean(SPATIAL([22,25,26,30,31,32,36,37,38,],:),1);
%     Right_LE = mean(SPATIAL([39,40,41,42,47,48,49,53,54,55,56,57,58],:),1);
%     Left_LE = mean(SPATIAL([43,44,45,46,50,51,52,59,60,61,62,63,64],:),1);

Head = mean(SPATIAL([16,17,18,19,20],:),1);
T_Spine = mean(SPATIAL([11,12,13,14,15],:),1);
L_Spine = mean(SPATIAL([9,10],:),1);
Pelvis = mean(SPATIAL([1,2,3,4,5,6,7,8],:),1);
Right_UARM = mean(SPATIAL([21,23,24],:),1);
Right_LARM = mean(SPATIAL([27,28,29],:),1);
Right_Hand = mean(SPATIAL([33,34,35],:),1);
Left_UARM = mean(SPATIAL([22,25,26],:),1); 
Left_LARM = mean(SPATIAL([30,31,32],:),1);
Left_Hand = mean(SPATIAL([36,37,38],:),1);
Right_ULEG = mean(SPATIAL([39,40,41,42],:),1);
Right_LLEG = mean(SPATIAL([47,48,49],:),1); 
Right_Foot = mean(SPATIAL([53,54,55,56,57,58],:),1); 
Left_ULEG = mean(SPATIAL([43,44,45,46],:),1); 
Left_LLEG = mean(SPATIAL([50,51,52],:),1);
Left_Foot = mean(SPATIAL([59,60,61,62,63,64],:),1);


    figure(2)
    subplot(a,b,n)
    h2 = biplot(Head,'VarLabels','1') % Axial
    h(1) = h2(1);
    hold on
    h3 = biplot(T_Spine,'VarLabels','2') % Right UE
    h(2) = h3(1);
    h4 = biplot(L_Spine,'VarLabels','3') % Left UE
    h(3) = h4(1);
    h5 = biplot(Pelvis,'VarLabels','4') % Right LE 
    h(4) = h5(1);
    h6 = biplot(Right_UARM,'VarLabels','5') % Left LE 
    h(5) = h6(1);
    h7 = biplot(Right_LARM,'VarLabels','6') % Axial
    h(6) = h7(1);
    hold on
    h8 = biplot(Right_Hand,'VarLabels','7') % Right UE
    h(7) = h8(1);
    h9 = biplot(Left_UARM,'VarLabels','8') % Left UE
    h(8) = h9(1);
    h10 = biplot(Left_LARM,'VarLabels','9') % Right LE 
    h(9) = h10(1);
    h11 = biplot(Left_Hand,'VarLabels','10') % Left LE 
    h(10) = h11(1);
    h12 = biplot(Right_ULEG,'VarLabels','11') % Axial
    h(11) = h12(1);
    hold on
    h13 = biplot(Right_LLEG,'VarLabels','12') % Right UE
    h(12) = h13(1);
    h14 = biplot(Right_Foot,'VarLabels','13') % Left UE
    h(13) = h14(1);
    h15 = biplot(Left_ULEG,'VarLabels','14') % Right LE 
    h(14) = h15(1);
    h16 = biplot(Left_LLEG,'VarLabels','15') % Left LE 
    h(15) = h16(1);
    h17 = biplot(Left_Foot,'VarLabels','16') % Left LE 
    h(15) = h17(1);
    legend('1 = Head','', '2 = T-spine','3 = L-spine','', '4 = Pelvis','', '5 = Right Upper Arm','','6 = Right Lower Arm','', '7 = Right Hand','', '8 = Left Upper Arm','', '9 = Left Lower Arm', '','10 = Left Hand','', '11 = Right Upper Leg', '','12 = Right Lower Leg', '', '13 = Right Foot', '', '14 = Left Upper Leg','', '15 = Left Lower Leg', '', '16 = Left Foot','','')
    xlim([-.001 .0025])
    ylim([-.001 .007])
    xline(0)
    yline(0)
    xlabel(join(['PC',pc_a]))
    ylabel(join(['PC',pc_b]))
    %colorbar

    h2(1).Color ='r';
    h3(1).Color ='g';
    h4(1).Color ='g';
    h5(1).Color ='c';
    h6(1).Color ='m';
    h7(1).Color ='m';
    h8(1).Color ='m'; 
    h9(1).Color ='b';	
    h10(1).Color ='b';
    h11(1).Color ='b';
    h12(1).Color =[0.8500 0.3250 0.0980];
    h13(1).Color =[0.8500 0.3250 0.0980];
    h14(1).Color =[0.8500 0.3250 0.0980];
    h15(1).Color ='k';
    h16(1).Color ='k'
    h17(1).Color ='k'

%     for k = 1:length(Axial);
%         h2(k).Color = 'k'; 
%     end 
% 
%     for k = 1:length(Right_UE);
%        h3(k).Color = 'b'; 
%     end 
%     
%     for k = 1:length(Right_UE);
%         h4(k).Color = 'c'; 
%     end 
% 
%     for k = 1:length(Right_LE);
%         h5(k).Color = 'r'; 
%     end 
% 
%     for k = 1:length(Right_LE);
%         h6(k).Color = 'm'; 
%     end 

    %legend (h,'Head','T-Spine','L-Spine','Pelvis','Right Arm','Left Arm', 'Right Leg','Left Leg')
end

%%
col=turbo(length(X2))
colormap(col); 


figure(1)
h1 = biplot(X)
title('x-position')
colorbar


figure(2)
h2 = biplot(X2)
colormap(col); 
colorbar

title('y-position')

figure(3)
h3 = biplot(X3)
colormap(col); 
colorbar

title('z-position')

for k = 1:length(X2);
    h1(k).Color = col(k,:);
end

for k = 1:length(X2);
    h2(k).Color = col(k,:);
end

for k = 1:length(X3); 
    h3(k).Color = col(k,:); 
end

%%
%Prep Video File
     open(myVideo);                  
% 
for n=1:100
%n=64;

x = mu(:,1:6464);
y = mu(:,6465:12928);
z = mu(:,12929:19392);

x = reshape(x,101,64);
y = reshape(y,101,64);
z = reshape(z,101,64);

% figure('units','normalized','outerposition',[0 0 1 1])
subplot(2,2,[1,3])
hold on
scatter3(x(n,:),y(n,:),z(n,:),10,'filled','k')
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'k')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'k')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'k')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'k')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'k')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'k')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'k')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'k')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'k')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'k')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'k')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'k')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'k')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'k')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'k')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'k')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'k')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'k')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'k')

%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'k')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'k')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'k')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'k')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'k')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'k')

grid on
axis equal
 ylim ([-800 400])
 xlim ([-800 800])
 zlim([-300 300])
xlabel 'X (mm)'
ylabel 'Y (mm)'
zlabel 'Z (mm)'
%view(0,90)
view(90,0)
camroll(90)


subplot(2,2,2)
hold on
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'k')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'k')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'k')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'k')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'k')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'k')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'k')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'k')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'k')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'k')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'k')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'k')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'k')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'k')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'k')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'k')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'k')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'k')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'k')

%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'k')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'k')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'k')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'k')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'k')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'k')

grid on
axis equal
 ylim ([-800 400])
 xlim ([-800 800])
 zlim([-300 300])
xlabel 'X (mm)'
ylabel 'Y (mm)'
zlabel 'Z (mm)'
view(0,0)

subplot(2,2,4)
hold on
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'k')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'k')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'k')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'k')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'k')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'k')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'k')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'k')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'k')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'k')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'k')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'k')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'k')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'k')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'k')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'k')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'k')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'k')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'k')

%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'k')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'k')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'k')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'k')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'k')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'k')

grid on
axis equal
 ylim ([-800 400])
 xlim ([-800 800])
 zlim([-300 300])
xlabel 'X (mm)'
ylabel 'Y (mm)'
zlabel 'Z (mm)'
view(0,90)

% Add on 95th and 5th percentile movers
% 
% ranked = sort(score(:,SCR));
% high = ranked(round(size(ranked,1)*0.95));
% low = ranked(round(size(ranked,1)*0.05));
% 
% % reconst_high = mu + (coeff(:,SCR)'*high) + (coeff(:,SCR2)'*high);
% % reconst_low = mu + (coeff(:,SCR)'*low) + (coeff(:,SCR2)'*low);
% reconst_high = mu + (coeff(:,SCR)'*high);
% reconst_low = mu + (coeff(:,SCR)'*low);

ranked1 = sort(score(:,SCR1));
high1 = ranked1(round(size(ranked1,1)*0.95));
low1 = ranked1(round(size(ranked1,1)*0.05));

ranked2 = sort(score(:,SCR1));
high2 = ranked2(round(size(ranked2,1)*0.95));
low2 = ranked2(round(size(ranked2,1)*0.05));

ranked3 = sort(score(:,SCR3));
high3 = ranked3(round(size(ranked3,1)*0.95));
low3 = ranked3(round(size(ranked3,1)*0.05));

ranked4 = sort(score(:,SCR4));
high4 = ranked4(round(size(ranked4,1)*0.95));
low4 = ranked4(round(size(ranked4,1)*0.05));

ranked5 = sort(score(:,SCR5));
high5 = ranked5(round(size(ranked5,1)*0.95));
low5 = ranked5(round(size(ranked5,1)*0.05));

ranked6 = sort(score(:,SCR6));
high6 = ranked6(round(size(ranked6,1)*0.95));
low6 = ranked6(round(size(ranked6,1)*0.05));

ranked7 = sort(score(:,SCR7));
high7 = ranked7(round(size(ranked7,1)*0.95));
low7 = ranked7(round(size(ranked7,1)*0.05));


reconst_high = mu + (coeff(:,SCR1)'*high1) + (coeff(:,SCR2)'*high2) + (coeff(:,SCR3)'*high3) + (coeff(:,SCR4)'*high4) + (coeff(:,SCR5)'*high5) + (coeff(:,SCR6)'*high6) + (coeff(:,SCR7)'*high7);
reconst_low = mu + (coeff(:,SCR1)'*low1) + (coeff(:,SCR2)'*low2) + (coeff(:,SCR3)'*low3) + (coeff(:,SCR4)'*low4) + (coeff(:,SCR5)'*low5) + (coeff(:,SCR6)'*low6) + (coeff(:,SCR7)'*low7);


% 95th Percentile
x = reconst_high(:,1:6464);
y = reconst_high(:,6465:12928);
z = reconst_high(:,12929:19392);

x = reshape(x,101,64);
y = reshape(y,101,64);
z = reshape(z,101,64);

subplot(2,2,[1,3])

%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'b')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'b')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'b')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'b')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'b')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'b')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'b')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'b')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'b')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'b')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'b')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'b')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'b')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'b')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'b')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'b')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'b')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'b')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'b')

%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'b')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'b')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'b')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'b')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'b')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'b')

grid on
axis equal
 ylim ([-800 400])
 xlim ([-800 800])
 zlim([-300 300])
xlabel 'X (mm)'
ylabel 'Y (mm)'
zlabel 'Z (mm)'
%view(0,90)
view(90,0)
%camroll(90)

subplot(2,2,2)
scatter3(x(n,:),y(n,:),z(n,:),10,'filled','b')
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'b')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'b')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'b')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'b')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'b')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'b')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'b')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'b')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'b')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'b')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'b')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'b')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'b')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'b')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'b')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'b')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'b')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'b')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'b')

%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'b')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'b')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'b')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'b')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'b')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'b')

grid on
axis equal
ylim ([-800 400])
xlim ([-800 800])
zlim([-300 300])
xlabel 'X (mm)'
ylabel 'Y (mm)'
zlabel 'Z (mm)'
view(0,0)

subplot(2,2,4)
scatter3(x(n,:),y(n,:),z(n,:),10,'filled','b')
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'b')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'b')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'b')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'b')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'b')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'b')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'b')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'b')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'b')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'b')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'b')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'b')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'b')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'b')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'b')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'b')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'b')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'b')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'b')

%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'b')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'b')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'b')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'b')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'b')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'b')

% grid on
% axis equal
% ylim ([-800 300])
% xlim ([-800 800])
% xlabel 'X (mm)'
% ylabel 'Y (mm)'
% zlabel 'Z (mm)'
% view(0,90)

% 5th Percentile
x = reconst_low(:,1:6464);
y = reconst_low(:,6465:12928);
z = reconst_low(:,12929:19392);

x = reshape(x,101,64);
y = reshape(y,101,64);
z = reshape(z,101,64);

subplot(2,2,[1,3])
scatter3(x(n,:),y(n,:),z(n,:),10,'filled','r')
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'r')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'r')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'r')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'r')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'r')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'r')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'r')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'r')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'r')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'r')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'r')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'r')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'r')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'r')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'r')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'r')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'r')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'r')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'r')
%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'r')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'r')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'r')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'r')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'r')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'r')


subplot(2,2,2)
scatter3(x(n,:),y(n,:),z(n,:),10,'filled','r')
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'r')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'r')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'r')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'r')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'r')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'r')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'r')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'r')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'r')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'r')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'r')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'r')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'r')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'r')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'r')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'r')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'r')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'r')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'r')
%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'r')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'r')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'r')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'r')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'r')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'r')

subplot(2,2,4)
scatter3(x(n,:),y(n,:),z(n,:),10,'filled','r')
%Axial
plot3(x(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),y(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),z(n,[2,3,5,4,2,6,7,3,7,8,6,8,9,10,11,14,16,21,12,15,11,15,21,15,22,15,12,22,16]),'r')
plot3(x(n,[22,11]),y(n,[22,11]),z(n,[22,11]),'r')
plot3(x(n,[21,11]),y(n,[21,11]),z(n,[21,11]),'r')
plot3(x(n,[17,18,19,17,20,18,20,19,20,16]),y(n,[17,18,19,17,20,18,20,19,20,16]),z(n,[17,18,19,17,20,18,20,19,20,16]),'r')

%Right-UE
plot3(x(n,[21,23,24,29,24,21]),y(n,[21,23,24,29,24,21]),z(n,[21,23,24,29,24,21]),'r')
plot3(x(n,[21,29,27,29,28,27]),y(n,[21,29,27,29,28,27]),z(n,[21,29,27,29,28,27]),'r')
plot3(x(n,[24,27,24,28,27]),y(n,[24,27,24,28,27]),z(n,[24,27,24,28,27]),'r')
plot3(x(n,[23,27,23,28,27]),y(n,[23,27,23,28,27]),z(n,[23,27,23,28,27]),'r')
plot3(x(n,[27,33,28,33,34,33,35,33,34,27]),y(n,[27,33,28,33,34,33,35,33,34,27]),z(n,[27,33,28,33,34,33,35,33,34,27]),'r')

%Left-UE
plot3(x(n,[22,25,26,25,32,22]),y(n,[22,25,26,25,32,22]),z(n,[22,25,26,25,32,22]),'r')
plot3(x(n,[22,26]),y(n,[22,26]),z(n,[22,26]),'r')
plot3(x(n,[30,31,25,30,25,31,25,26,30,26,31,26]),y(n,[30,31,25,30,25,31,25,26,30,26,31,26]),z(n,[30,31,25,30,25,31,25,26,30,26,31,26]),'r')
plot3(x(n,[32,30,31,30,32,31,32]),y(n,[32,30,31,30,32,31,32]),z(n,[32,30,31,30,32,31,32]),'r')
plot3(x(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),y(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),z(n,[30,36,30,37,30,38,36,37,31,36,31,37,31,38,31]),'r')

%Right-LE
plot3(x(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),y(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),z(n,[39,40,39,41,39,42,41,40,42,47,40,47,41,47]),'r')
plot3(x(n,[47,48,47,49]),y(n,[47,48,47,49]),z(n,[47,48,47,49]),'r')
plot3(x(n,[40,48,40,49]),y(n,[40,48,40,49]),z(n,[40,48,40,49]),'r')
plot3(x(n,[41,48,41,49]),y(n,[41,48,41,49]),z(n,[41,48,41,49]),'r')
plot3(x(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),y(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),z(n,[48,49,53,48,53,54,53,55,53,56,57,56,58,53]),'r')
%Left-LE
plot3(x(n,[43,44,43,45,43,46,45,44,46]),y(n,[43,44,43,45,43,46,45,44,46]),z(n,[43,44,43,45,43,46,45,44,46]),'r')
plot3(x(n,[50,46,50,45,50,44,50]),y(n,[50,46,50,45,50,44,50]),z(n,[50,46,50,45,50,44,50]),'r')
plot3(x(n,[50,51,50,52,50]),y(n,[50,51,50,52,50]),z(n,[50,51,50,52,50]),'r')
plot3(x(n,[44,51,44,52,44]),y(n,[44,51,44,52,44]),z(n,[44,51,44,52,44]),'r')
plot3(x(n,[45,51,45,52,45]),y(n,[45,51,45,52,45]),z(n,[45,51,45,52,45]),'r')
plot3(x(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),y(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),z(n,[51,52,51,59,52,59,60,59,60,59,62,59,61,62,63,62,64]),'r')



F = getframe(gcf);
            writeVideo(myVideo,F);
            hold off
            close all
end

%% 
for n=1:length(PCAINPUT.SEX)
    SEX(n)=convertCharsToStrings(PCAINPUT.SEX(n,:)); 
end

for n=1:length(SEX)
    A= SEX(n);
    if A=='M'
        TSEX(n,:)=1; 
        if A=='F';
            TSEX(n,:)=0;
         end
    end
end


VMAX=PCAINPUT.VMAX;
PCSCORESVMAX=[VMAX,score];

X=[PCSCORESVMAX(:,2:16),TSEX,PCAINPUT.Height,PCAINPUT.AGE];
Y=PCSCORESVMAX(:,1);
model=stepwiselm(X,Y)
figure(2)
plot(model)
terms='x3:x11 + x9:x11 + x11:x16 + x12:x16';
Newmodel=removeTerms(model,terms)

plot(Newmodel)



%% Fitted Values vs Actual Data
X= Newmodel.Fitted; 
Y=PCSCORESVMAX(:,1); 

Coeff_Determ = fitlm(X,Y); 

figure(4) % Plot of Fitted Values vs Acutal Data 
plot(Coeff_Determ)
hold on
%scatter(X,Y,50,DarkBlue,'Filled'); 
xlabel('Fitted Values (m/s')
ylabel('Maximal Velocity (m/s)')
xlim([6.5 9.2])
ylim([6.5 9.2])
set(gca,'FontSize',15)

% Plot Residuals agains the Fitted data - Residuals represent what is left
% in the response once all linear effects of the explanatory variables are
% taken out
X = Newmodel.Fitted;
Y = table2array(Coeff_Determ.Residuals(:,1));

figure(5) % Plot Fitted Values against the residuals 
scatter(X,Y,50,DarkBlue,'Filled')
xlabel('Fitted Values (m/s)')
ylabel('Residuals')
set(gca,'FontSize',15)

X1 = PCSCORESVMAX(:,2); 
X3 = PCSCORESVMAX(:,4); 
X9 = PCSCORESVMAX(:,10); 
X11 = PCSCORESVMAX(:,12);
X12 = PCSCORESVMAX(:,13);
X13 = PCSCORESVMAX(:,14);
X16 = PCSCORESVMAX(:,17);
X20 = PCSCORESVMAX(:,21);

MODELPCS = [PCSCORESVMAX(:,2),PCSCORESVMAX(:,4), PCSCORESVMAX(:,10),PCSCORESVMAX(:,12), PCSCORESVMAX(:,13),PCSCORESVMAX(:,14),PCSCORESVMAX(:,17),PCSCORESVMAX(:,21)];

figure(6)

for k = 1:8 
    subplot(2,4,k)
    scatter(MODELPCS(:,k),Y)
end

%% Create PC SCORE VS VMAX 

X = PCSCORESVMAX(:,2:17);
Y = PCSCORESVMAX(:,1);


for k =1:15 
    t = X(:,k); 
    Line = polyfit(t,Y,1); 
    LineVal = polyval(Line,t); 
    COR = round(corr(t,Y),3); 
    tCOR = join(['r=',string(COR)]); 
    
    col = turbo(length(PCSCORESVMAX)); 

    for n = 1:length(col)
        figure(4)
        subplot(4,4,k)
        hold on
        scatter(t(n,:),Y(n,:),20,DarkBlue,'filled')
    end
    plot(t,LineVal,'r','LineStyle','-.','Color',lightBlue,'LineWidth',1)
    xlim([min(t) max(t)])
    NE = [(max(xlim)-(max(xlim)*.8)) max(ylim)]-[diff(xlim) diff(ylim)]*0.05;
    text(NE(1),NE(2),tCOR)
    xla = string(k);
    xlabel(join(['PC',xla,'Scores']))
    ylabel('Maximum Velocity (m/s)')
    hold off
end

RY=sort(Y,'Ascend')
Ymin = round(min(RY),1); 
Y25 = round(RY(10),1); 
Y50 = round(RY(20),1); 
Y75 = round(RY(30),1); 
Ymax = round(max(RY),1);

XTICKS = [Ymin, Y25,  Y50, Y75, Ymax];
SXTICKS = string([Ymin, Y25,  Y50, Y75, Ymax]);




